# Lazy load nvm
# https://www.reddit.com/r/node/comments/4tg5jg/lazy_load_nvm_for_faster_shell_start/d5ib9fs

load_nvm () {
    # Exit early for safety, in case this is called more than once.
    type -t nvm >/dev/null && return

    echo "nvm..."

    # Load nvm.
    export NVM_DIR=~/.nvm
    [ -s $(brew --prefix nvm)/nvm.sh ] && . $(brew --prefix nvm)/nvm.sh
}

load_grunt_completion () {
    echo "grunt completion..."
    # Grunt bash completion. First try local grunt-cli, then global grunt-cli.
    # Do nothing if neither exist.
    if [ -f $(npm bin)/grunt ]; then
        eval "$($(npm bin)/grunt --completion=bash)"
    else
        which grunt &>/dev/null && eval "$(grunt --completion=bash)"
    fi
}

declare -a NODE_GLOBALS=($(find ~/.nvm/versions/node -maxdepth 3 -type l -wholename '*/bin/*' | xargs -n1 basename | sort | uniq))

NODE_GLOBALS+=("node")
NODE_GLOBALS+=("nvm")

# Create empty scripts dir and add to PATH
RUBY_TMP_DIR=/tmp/node_globals
# Allow path string to be used in sed with / delimiter: http://stackoverflow.com/a/27789859/3150057
RUBY_TMP_DIR_SED=${RUBY_TMP_DIR//\//\\/}
mkdir $RUBY_TMP_DIR
export PATH="$PATH:$RUBY_TMP_DIR"

clean_up_node_globals () {
    # Remove empty scripts
    (cd $RUBY_TMP_DIR && rm ${NODE_GLOBALS[@]})
    # Reset PATH by removing empty scripts dir: http://stackoverflow.com/a/18925756/3150057
    export PATH=$(echo $PATH | sed -e "s/:$RUBY_TMP_DIR_SED//")
    # Remove all node binary functions made below
    unset -f ${NODE_GLOBALS[@]}
}

for cmd in "${NODE_GLOBALS[@]}"; do
    # Make empty script with shebang so SublimeLinter can load it: http://stackoverflow.com/a/27608363/3150057
    echo "#!/bin/sh" > $RUBY_TMP_DIR/$cmd
    chmod +x $RUBY_TMP_DIR/$cmd
    eval "${cmd}(){
        clean_up_node_globals
        load_nvm
        # Lazy-load grunt completion
        grunt () {
            unset grunt
            load_grunt_completion
            grunt $@
        }
        ${cmd} \$@
    }"
done
