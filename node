# Lazy load nvm
# https://www.reddit.com/r/node/comments/4tg5jg/lazy_load_nvm_for_faster_shell_start/d5ib9fs

load_nvm () {
    # Exit early for safety, in case this is called more than once.
    type -t nvm >/dev/null && return

    # Load nvm.
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

    # Sets nodejs path.
    export NODE_PATH="$NODE_PATH:$(npm root -g)"

}

load_grunt_completion () {
    # Grunt bash completion. First try local grunt-cli, then global grunt-cli.
    # Do nothing if neither exist.
    if [ -f $(npm bin)/grunt ]; then
        eval "$($(npm bin)/grunt --completion=bash)"
    else
        which grunt &>/dev/null && eval "$(grunt --completion=bash)"
    fi
}

# Lazy-load grunt completion separately.
grunt () {
    unset grunt
    load_grunt_completion
    grunt \$@
}

# Load nvm straight away so Sublime Text can use it for linters.
NVM_LAZY_LOAD=0

if [ $NVM_LAZY_LOAD -eq 1 ]; then
    declare -a NODE_GLOBALS=($(find $HOME/.nvm/versions/node -maxdepth 3 -type l -wholename '*/bin/*' | xargs -n1 basename | sort | uniq))

    NODE_GLOBALS+=("node")
    NODE_GLOBALS+=("nvm")

    for cmd in "${NODE_GLOBALS[@]}"; do
        eval "${cmd}(){ unset -f ${NODE_GLOBALS[@]}; load_nvm; ${cmd} \$@; }"
    done
else
    load_nvm
fi
